{% extends "base.html" %}

{% block title %}Dashboard - oMLX Admin{% endblock %}

{% block head %}
<style>
    /* CSS Variables for theming (shared with chat.html) */
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f8fafc;
        --bg-tertiary: #f1f5f9;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-tertiary: #64748b;
        --text-muted: #94a3b8;
        --border-faint: #e2e8f0;
        --border-normal: #cbd5e1;
        --code-bg: #f3f4f6;
    }

    [data-theme="dark"] {
        --bg-primary: #1d1d20;
        --bg-secondary: #252529;
        --bg-tertiary: #2d2d32;
        --text-primary: #efefef;
        --text-secondary: #a1a1aa;
        --text-tertiary: #71717a;
        --text-muted: #52525b;
        --border-faint: #3f3f46;
        --border-normal: #52525b;
        --code-bg: #27272a;
    }

    body {
        background-color: var(--bg-primary) !important;
        color: var(--text-primary) !important;
    }

    /* === Page-level backgrounds === */
    [data-theme="dark"] .bg-white { background-color: var(--bg-primary) !important; }
    [data-theme="dark"] .bg-white\/80 { background-color: rgba(29, 29, 32, 0.8) !important; }
    [data-theme="dark"] .bg-neutral-50 { background-color: var(--bg-secondary) !important; }
    [data-theme="dark"] .bg-neutral-50\/50 { background-color: rgba(37, 37, 41, 0.5) !important; }
    [data-theme="dark"] .bg-neutral-100 { background-color: var(--bg-tertiary) !important; }
    [data-theme="dark"] .bg-neutral-200 { background-color: var(--bg-tertiary) !important; }

    /* === Text colors === */
    [data-theme="dark"] .text-neutral-900 { color: var(--text-primary) !important; }
    [data-theme="dark"] .text-neutral-800 { color: var(--text-primary) !important; }
    [data-theme="dark"] .text-neutral-700 { color: var(--text-secondary) !important; }
    [data-theme="dark"] .text-neutral-600 { color: var(--text-secondary) !important; }
    [data-theme="dark"] .text-neutral-500 { color: var(--text-tertiary) !important; }
    [data-theme="dark"] .text-neutral-400 { color: var(--text-muted) !important; }
    [data-theme="dark"] .text-neutral-300 { color: var(--text-muted) !important; }

    /* === Borders === */
    [data-theme="dark"] .border-neutral-100 { border-color: var(--border-faint) !important; }
    [data-theme="dark"] .border-neutral-200 { border-color: var(--border-faint) !important; }
    [data-theme="dark"] .border-neutral-300 { border-color: var(--border-normal) !important; }
    [data-theme="dark"] .divide-neutral-100 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-faint) !important; }
    [data-theme="dark"] .divide-neutral-200 > :not([hidden]) ~ :not([hidden]) { border-color: var(--border-faint) !important; }

    /* === Hover states === */
    [data-theme="dark"] .hover\:bg-neutral-100:hover { background-color: var(--bg-tertiary) !important; }
    [data-theme="dark"] .hover\:bg-neutral-50:hover { background-color: var(--bg-secondary) !important; }
    [data-theme="dark"] .hover\:text-neutral-900:hover { color: var(--text-primary) !important; }
    [data-theme="dark"] .hover\:text-neutral-700:hover { color: var(--text-primary) !important; }
    [data-theme="dark"] .hover\:text-neutral-600:hover { color: var(--text-secondary) !important; }

    /* === Active nav tab (bg-white with shadow inside dark nav) === */
    [data-theme="dark"] .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3) !important; }

    /* === Settings dropdown === */
    [data-theme="dark"] .shadow-lg { box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.5) !important; }

    /* === Buttons: bg-neutral-900 text-white â†’ invert in dark mode === */
    [data-theme="dark"] button.bg-neutral-900,
    [data-theme="dark"] a.bg-neutral-900 {
        background-color: #e5e5e5 !important;
        color: #18181b !important;
    }
    [data-theme="dark"] button.hover\:bg-neutral-800:hover,
    [data-theme="dark"] a.hover\:bg-neutral-800:hover {
        background-color: #d4d4d8 !important;
    }
    /* Status badge inversion */
    [data-theme="dark"] span.bg-neutral-900 {
        background-color: #e5e5e5 !important;
        color: #18181b !important;
    }
    [data-theme="dark"] span.bg-neutral-900 span {
        color: #18181b !important;
    }
    [data-theme="dark"] span.bg-neutral-900 span.bg-white {
        background-color: #18181b !important;
    }
    /* Inverted button text */
    [data-theme="dark"] button.bg-neutral-900 .text-white,
    [data-theme="dark"] button.bg-neutral-900 span,
    [data-theme="dark"] button.bg-neutral-900 svg {
        color: #18181b !important;
    }
    /* Spinner inside inverted button */
    [data-theme="dark"] button.bg-neutral-900 svg.animate-spin circle { stroke: #18181b; }
    [data-theme="dark"] button.bg-neutral-900 svg.animate-spin path { fill: #18181b; }

    /* === Log viewer: keep dark === */
    [data-theme="dark"] div.bg-neutral-900 { background-color: #0f0f11 !important; }
    [data-theme="dark"] textarea.bg-neutral-900 { background-color: #0f0f11 !important; color: #4ade80 !important; }
    [data-theme="dark"] .bg-neutral-800 { background-color: #1a1a1d !important; }
    [data-theme="dark"] .border-neutral-700 { border-color: #3f3f46 !important; }
    [data-theme="dark"] .text-green-400 { color: #4ade80 !important; }
    [data-theme="dark"] .text-green-500 { color: #22c55e !important; }

    /* === Input fields === */
    [data-theme="dark"] input:not([type="range"]),
    [data-theme="dark"] select,
    [data-theme="dark"] textarea:not(.bg-neutral-900) {
        background-color: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: var(--border-faint) !important;
    }
    [data-theme="dark"] input:not([type="range"]):focus,
    [data-theme="dark"] select:focus,
    [data-theme="dark"] textarea:not(.bg-neutral-900):focus {
        box-shadow: 0 0 0 2px rgba(255,255,255,0.1) !important;
        border-color: var(--border-normal) !important;
    }
    [data-theme="dark"] select option {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }

    /* === Code/pre blocks === */
    [data-theme="dark"] code { background-color: var(--code-bg) !important; color: var(--text-primary) !important; }
    [data-theme="dark"] pre:not(.bg-neutral-100) { background-color: var(--code-bg) !important; color: var(--text-primary) !important; }

    /* === Focus rings === */
    [data-theme="dark"] .focus\:ring-neutral-900:focus { --tw-ring-color: var(--border-normal) !important; }
    [data-theme="dark"] .focus\:ring-black:focus { --tw-ring-color: var(--border-normal) !important; }
    [data-theme="dark"] .focus\:ring-2:focus { --tw-ring-color: var(--border-normal) !important; }

    /* === Toggle switches (ON state: bg-black) === */
    [data-theme="dark"] button.bg-black {
        background-color: #a1a1aa !important;
    }
    [data-theme="dark"] button.bg-black span.bg-white {
        background-color: #ffffff !important;
    }
    /* Toggle OFF state */
    [data-theme="dark"] button.bg-neutral-200 {
        background-color: var(--bg-tertiary) !important;
    }
    /* Default radio button (ON state) */
    [data-theme="dark"] button.bg-black.border-black {
        background-color: #a1a1aa !important;
        border-color: #a1a1aa !important;
    }
    [data-theme="dark"] button.border-neutral-300 {
        border-color: var(--border-normal) !important;
    }
    [data-theme="dark"] button.hover\:border-neutral-400:hover {
        border-color: var(--text-muted) !important;
    }

    /* === Range slider === */
    [data-theme="dark"] input[type="range"] {
        background-color: var(--border-faint) !important;
    }
    [data-theme="dark"] input[type="range"]::-webkit-slider-thumb {
        background-color: #a1a1aa !important;
    }

    /* === Badge colors (dark mode adjustments) === */
    [data-theme="dark"] .bg-green-50 { background-color: rgba(34, 197, 94, 0.15) !important; }
    [data-theme="dark"] .border-green-200 { border-color: rgba(34, 197, 94, 0.3) !important; }
    [data-theme="dark"] .text-green-600 { color: #4ade80 !important; }
    [data-theme="dark"] .text-green-700 { color: #4ade80 !important; }
    [data-theme="dark"] .bg-green-500 { background-color: #22c55e !important; }
    [data-theme="dark"] .bg-amber-50 { background-color: rgba(245, 158, 11, 0.15) !important; }
    [data-theme="dark"] .border-amber-200 { border-color: rgba(245, 158, 11, 0.3) !important; }
    [data-theme="dark"] .text-amber-600 { color: #fbbf24 !important; }
    [data-theme="dark"] .bg-blue-50 { background-color: rgba(59, 130, 246, 0.15) !important; }
    [data-theme="dark"] .border-blue-200 { border-color: rgba(59, 130, 246, 0.3) !important; }
    [data-theme="dark"] .text-blue-700 { color: #93c5fd !important; }
    [data-theme="dark"] .bg-orange-50 { background-color: rgba(249, 115, 22, 0.15) !important; }
    [data-theme="dark"] .border-orange-200 { border-color: rgba(249, 115, 22, 0.3) !important; }
    [data-theme="dark"] .text-orange-700 { color: #fdba74 !important; }
    [data-theme="dark"] .bg-purple-50 { background-color: rgba(168, 85, 247, 0.15) !important; }
    [data-theme="dark"] .border-purple-200 { border-color: rgba(168, 85, 247, 0.3) !important; }
    [data-theme="dark"] .text-purple-700 { color: #c4b5fd !important; }
    [data-theme="dark"] .bg-red-50 { background-color: rgba(239, 68, 68, 0.15) !important; }
    [data-theme="dark"] .border-red-200 { border-color: rgba(239, 68, 68, 0.3) !important; }
    [data-theme="dark"] .text-red-500 { color: #f87171 !important; }
    [data-theme="dark"] .text-red-600 { color: #ef4444 !important; }
    [data-theme="dark"] .text-red-700 { color: #fca5a5 !important; }

    /* === Gradient background effect === */
    [data-theme="dark"] .from-neutral-50 { --tw-gradient-from: var(--bg-secondary) !important; }

    /* === Background grain texture in dark mode === */
    [data-theme="dark"] .bg-grain { opacity: 0.02; }

    /* === Modal shadow === */
    [data-theme="dark"] .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important; }

    /* === Selection text === */
    [data-theme="dark"] ::selection { background-color: #3f3f46; color: var(--text-primary); }

    /* === Disabled states === */
    [data-theme="dark"] .disabled\:opacity-50:disabled { opacity: 0.5; }

    /* === Hover bg for model rows === */
    [data-theme="dark"] .hover\:bg-neutral-50:hover { background-color: var(--bg-secondary) !important; }

    /* === Copy button bg-white/80 === */
    [data-theme="dark"] .bg-white\/80 { background-color: rgba(29, 29, 32, 0.8) !important; }


</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-white flex flex-col" x-data="dashboard()" x-init="init()">
    <!-- Navigation Bar -->
    <nav class="w-full py-5 px-6 md:px-12 border-b border-neutral-100 bg-white/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center gap-2">
                <img x-show="theme === 'light'" src="/admin/static/navbar-logo-light.svg" alt="oMLX" class="w-8 h-8">
                <img x-show="theme === 'dark'" src="/admin/static/navbar-logo-dark.svg" alt="oMLX" class="w-8 h-8" x-cloak>
                <span class="font-bold tracking-tight text-lg">oMLX</span>
                <span class="text-sm text-neutral-400 ml-1">Admin</span>
            </div>

            <!-- Center Navigation -->
            <div class="flex items-center gap-1 bg-neutral-100 rounded-full p-1">
                <button
                    @click="mainTab = 'status'"
                    :class="mainTab === 'status'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'"
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1.5"
                >
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    Status
                </button>
                <button
                    @click="mainTab = 'models'; if (!hfModelsLoaded) { loadHFModels(); loadHFTasks(); }"
                    :class="mainTab === 'models'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'"
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1.5"
                >
                    <i data-lucide="hard-drive-download" class="w-4 h-4"></i>
                    Models
                </button>
                <div class="relative" @mouseenter="settingsDropdown = true" @mouseleave="settingsDropdown = false">
                    <button
                        @click="mainTab = 'settings'"
                        :class="mainTab === 'settings'
                            ? 'bg-white text-neutral-900 shadow-sm'
                            : 'text-neutral-600 hover:text-neutral-900'"
                        class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1.5"
                    >
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        Settings
                        <i data-lucide="chevron-down" class="w-3 h-3 ml-0.5 opacity-50 hidden"></i>
                    </button>
                    <div
                        x-show="settingsDropdown"
                        x-transition:enter="transition ease-out duration-150"
                        x-transition:enter-start="opacity-0 translate-y-1"
                        x-transition:enter-end="opacity-100 translate-y-0"
                        x-transition:leave="transition ease-in duration-100"
                        x-transition:leave-start="opacity-100 translate-y-0"
                        x-transition:leave-end="opacity-0 translate-y-1"
                        class="absolute left-1/2 -translate-x-1/2 mt-1.5 w-44 bg-white rounded-xl shadow-lg border border-neutral-200 py-1.5 z-[60]"
                        x-cloak
                    >
                        <button
                            @click="mainTab = 'settings'; activeTab = 'global'; settingsDropdown = false"
                            class="w-full px-4 py-2 text-left text-sm font-medium transition-colors duration-150 flex items-center gap-2 rounded-lg mx-auto"
                            :class="mainTab === 'settings' && activeTab === 'global'
                                ? 'text-neutral-900 bg-neutral-100'
                                : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-50'"
                        >
                            <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                            Global Settings
                        </button>
                        <button
                            @click="mainTab = 'settings'; activeTab = 'models'; settingsDropdown = false"
                            class="w-full px-4 py-2 text-left text-sm font-medium transition-colors duration-150 flex items-center gap-2 rounded-lg mx-auto"
                            :class="mainTab === 'settings' && activeTab === 'models'
                                ? 'text-neutral-900 bg-neutral-100'
                                : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-50'"
                        >
                            <i data-lucide="cpu" class="w-3.5 h-3.5"></i>
                            Model Settings
                        </button>
                    </div>
                </div>
                <button
                    @click="mainTab = 'logs'; if (!logContent) loadLogs()"
                    :class="mainTab === 'logs'
                        ? 'bg-white text-neutral-900 shadow-sm'
                        : 'text-neutral-600 hover:text-neutral-900'"
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1.5"
                >
                    <i data-lucide="scroll-text" class="w-4 h-4"></i>
                    Logs
                </button>
                <a
                    href="/admin/chat"
                    class="px-4 py-1.5 rounded-full text-sm font-medium transition-all duration-200 flex items-center gap-1.5 text-neutral-600 hover:text-neutral-900"
                >
                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                    Chat
                </a>
            </div>

            <!-- Right: Theme Toggle + Logout -->
            <div class="flex items-center gap-2">
                <!-- Theme Toggle -->
                <button
                    @click="toggleTheme()"
                    class="p-2 rounded-full transition-all duration-200"
                    :class="theme === 'dark'
                        ? 'text-amber-400 hover:bg-neutral-700'
                        : 'text-neutral-500 hover:text-neutral-900 hover:bg-neutral-100'"
                    :title="theme === 'light' ? 'Dark Mode' : 'Light Mode'"
                >
                    <i x-show="theme === 'light'" data-lucide="sun" class="w-4 h-4"></i>
                    <i x-show="theme === 'dark'" data-lucide="moon" class="w-4 h-4" x-cloak></i>
                </button>

                <!-- Logout Button -->
                <button
                    @click="logout"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium text-neutral-600
                           hover:text-neutral-900 hover:bg-neutral-100 rounded-full transition-all duration-200"
                >
                    <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow relative overflow-hidden">
        <!-- Background Effects -->
        <div class="absolute inset-0 bg-grain pointer-events-none z-0"></div>
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[400px] bg-gradient-to-b from-neutral-50 to-transparent rounded-full blur-3xl -z-10 opacity-50"></div>

        <div class="max-w-7xl mx-auto px-6 py-10 relative z-10">
            <!-- Status Main Tab -->
            <div x-show="mainTab === 'status'" x-cloak>
                <div class="animate-fade-in-up">
                    <!-- Serving Stats Header -->
                    <div class="flex items-end justify-between mb-8">
                        <div>
                            <h2 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-2">Status</h2>
                            <h3 class="text-2xl font-bold tracking-tight text-neutral-900">Serving Stats</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="clearStats()"
                                    class="px-3 py-1.5 text-xs font-medium text-neutral-500 hover:text-neutral-700 hover:bg-neutral-100 rounded-lg transition-all flex items-center gap-1.5"
                                    title="Clear all metrics">
                                <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                                Clear
                            </button>
                            <select x-model="selectedStatsModel"
                                    @change="loadStats()"
                                    class="px-3 py-1.5 text-xs font-medium border border-neutral-200 rounded-lg bg-white focus:ring-2 focus:ring-neutral-900 focus:border-neutral-900 transition-all">
                                <option value="">All Models</option>
                                <template x-for="m in llmModels" :key="m.id">
                                    <option :value="m.id" x-text="m.id"></option>
                                </template>
                            </select>
                        </div>
                    </div>

                    <!-- Three Stat Cards -->
                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <!-- Total Tokens Served -->
                        <div class="bg-white rounded-2xl border border-neutral-200 p-8 text-center">
                            <p class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-3">Total Tokens Processed</p>
                            <p class="font-bold tracking-tight text-neutral-900 transition-all"
                               :class="getStatFontClass(stats.total_prompt_tokens)"
                               x-text="formatNumber(stats.total_prompt_tokens)"></p>
                        </div>

                        <!-- Cached Tokens Served -->
                        <div class="bg-white rounded-2xl border border-neutral-200 p-8 text-center">
                            <p class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-3">Cached Tokens</p>
                            <p class="font-bold tracking-tight text-neutral-900 transition-all"
                               :class="getStatFontClass(stats.total_cached_tokens)"
                               x-text="formatNumber(stats.total_cached_tokens)"></p>
                        </div>

                        <!-- Cache Efficiency -->
                        <div class="bg-white rounded-2xl border border-neutral-200 p-8 text-center">
                            <p class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-3">Cache Efficiency</p>
                            <p class="font-bold tracking-tight text-neutral-900 transition-all"
                               :class="getStatFontClass(stats.cache_efficiency)"
                               x-text="stats.cache_efficiency.toFixed(1) + '%'"></p>
                        </div>
                    </div>

                    <!-- Speed Stats -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-8">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="gauge" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Average Speed</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 divide-x divide-neutral-100">
                            <div class="p-6">
                                <p class="text-xs text-neutral-500 mb-1">Prompt Processing <span class="text-neutral-400">(excl. cached)</span></p>
                                <p class="text-2xl font-bold text-neutral-900" x-text="stats.avg_prefill_tps.toFixed(1) + ' tok/s'"></p>
                            </div>
                            <div class="p-6">
                                <p class="text-xs text-neutral-500 mb-1">Token Generation</p>
                                <p class="text-2xl font-bold text-neutral-900" x-text="stats.avg_generation_tps.toFixed(1) + ' tok/s'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- API Endpoints -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-8">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="link" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">API Endpoints</span>
                            </div>
                        </div>
                        <div class="divide-y divide-neutral-100">
                            <div class="flex items-center justify-between px-6 py-4">
                                <label class="text-sm text-neutral-700 font-medium">OpenAI API</label>
                                <div class="flex items-center gap-2">
                                    <code class="px-3 py-1.5 bg-neutral-50 rounded-lg text-sm font-mono"
                                          x-text="'http://localhost:' + stats.port + '/v1'"></code>
                                    <button x-data="{ copied: false }"
                                            @click="copyToClipboard('http://localhost:' + stats.port + '/v1'); copied = true; setTimeout(() => copied = false, 2000)"
                                            class="p-1.5 rounded-lg transition-all"
                                            :class="copied ? 'text-green-500' : 'text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100'"
                                            title="Copy">
                                        <svg x-show="!copied" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                        <svg x-show="copied" x-cloak class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center justify-between px-6 py-4">
                                <label class="text-sm text-neutral-700 font-medium">Claude API</label>
                                <div class="flex items-center gap-2">
                                    <code class="px-3 py-1.5 bg-neutral-50 rounded-lg text-sm font-mono"
                                          x-text="'http://localhost:' + stats.port"></code>
                                    <button x-data="{ copied: false }"
                                            @click="copyToClipboard('http://localhost:' + stats.port); copied = true; setTimeout(() => copied = false, 2000)"
                                            class="p-1.5 rounded-lg transition-all"
                                            :class="copied ? 'text-green-500' : 'text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100'"
                                            title="Copy">
                                        <svg x-show="!copied" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                        <svg x-show="copied" x-cloak class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Claude Code with oMLX -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="terminal" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Claude Code with oMLX</span>
                            </div>
                        </div>
                        <div class="px-6 py-5">
                            <div class="flex gap-4 items-start">
                                <!-- Left: Model Selector -->
                                <div class="w-64 flex-shrink-0">
                                    <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Model</label>
                                    <select x-model="selectedClaudeModel"
                                            class="w-full px-3 py-2.5 text-sm border border-neutral-200 rounded-lg bg-white focus:ring-2 focus:ring-neutral-900 focus:border-neutral-900 transition-all">
                                        <template x-for="m in llmModels" :key="m.id">
                                            <option :value="m.id" x-text="m.id"></option>
                                        </template>
                                    </select>
                                </div>

                                <!-- Right: Command -->
                                <div class="flex-1 min-w-0">
                                    <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Command</label>
                                    <div class="relative group">
                                        <pre class="px-4 py-3 pr-12 bg-neutral-100 text-neutral-800 rounded-lg text-xs font-mono overflow-x-auto whitespace-pre-wrap break-all leading-relaxed"
                                             x-text="claudeCodeCommand"></pre>
                                        <button x-data="{ copied: false }"
                                                @click="copyToClipboard(claudeCodeCommand); copied = true; setTimeout(() => copied = false, 2000)"
                                                class="absolute top-2.5 right-2.5 p-1.5 rounded-md transition-all opacity-0 group-hover:opacity-100"
                                                :class="copied ? 'text-green-500 opacity-100' : 'bg-white/80 text-neutral-400 hover:text-neutral-700'"
                                                title="Copy command">
                                            <svg x-show="!copied" class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                            <svg x-show="copied" x-cloak class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Context Scaling for Claude Code -->
                            <div class="mt-4 pt-4 border-t border-neutral-100">
                                <div class="flex gap-4 items-center">
                                    <div class="flex items-center gap-3">
                                        <label class="text-xs font-bold uppercase tracking-wider text-neutral-500">Context Scaling for Claude Code</label>
                                        <button type="button"
                                                @click="globalSettings.claude_code.context_scaling_enabled = !globalSettings.claude_code.context_scaling_enabled; saveClaudeCodeSettings()"
                                                :class="globalSettings.claude_code.context_scaling_enabled ? 'bg-neutral-900' : 'bg-neutral-200'"
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200">
                                            <span :class="globalSettings.claude_code.context_scaling_enabled ? 'translate-x-5' : 'translate-x-0'"
                                                  class="inline-block h-5 w-5 transform rounded-full bg-white shadow mt-0.5 ml-0.5 transition duration-200"></span>
                                        </button>
                                    </div>

                                    <div class="flex items-center gap-2" x-show="globalSettings.claude_code.context_scaling_enabled" x-cloak>
                                        <label class="text-xs font-bold uppercase tracking-wider text-neutral-500 whitespace-nowrap">Target Context Size</label>
                                        <input type="number"
                                               x-model.number="globalSettings.claude_code.target_context_size"
                                               @change="saveClaudeCodeSettings()"
                                               min="1024" step="1024"
                                               class="w-32 px-3 py-1.5 text-sm border border-neutral-200 rounded-lg bg-white focus:ring-2 focus:ring-neutral-900 focus:border-neutral-900 transition-all">
                                        <span class="text-xs text-neutral-400">tokens</span>
                                    </div>
                                </div>
                                <p class="mt-2 text-xs text-neutral-400 leading-relaxed">Scales token usage so Claude Code's auto-compact triggers correctly with smaller context models.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Main Tab -->
            <div x-show="mainTab === 'settings'" x-cloak>
            <!-- Tab Navigation -->
            <div class="flex items-center gap-2 mb-10 animate-fade-in-up">
                <button
                    @click="activeTab = 'global'"
                    :class="activeTab === 'global'
                        ? 'bg-neutral-900 text-white'
                        : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'"
                    class="px-5 py-2.5 rounded-full text-sm font-medium transition-all duration-200"
                >
                    Global Settings
                </button>
                <button
                    @click="activeTab = 'models'"
                    :class="activeTab === 'models'
                        ? 'bg-neutral-900 text-white'
                        : 'text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100'"
                    class="px-5 py-2.5 rounded-full text-sm font-medium transition-all duration-200"
                >
                    Model Settings
                </button>
            </div>

            <!-- Global Settings Tab -->
            <div x-show="activeTab === 'global'" x-cloak>
                <div class="animate-fade-in-up">
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-2">Global Settings</h2>
                        <h3 class="text-2xl font-bold tracking-tight text-neutral-900">Server Configuration</h3>
                        <p class="text-sm text-neutral-500 mt-2">
                            Settings marked with <span class="px-1 py-0.5 text-[9px] font-medium rounded bg-amber-50 text-amber-600 border border-amber-200">Restart</span> require server restart.
                        </p>
                    </div>

                    <!-- Settings Sections -->
                    <div class="space-y-4">

                        <!-- Auth & Info Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="shield" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Auth & Info</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Base Path</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Read-only</p>
                                    </div>
                                    <span class="text-sm text-neutral-700 font-mono" x-text="globalSettings.base_path || '~/.omlx'"></span>
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">API Key</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Min 4 chars, no whitespace</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input :type="showApiKey ? 'text' : 'password'"
                                               x-model="globalSettings.auth.api_key"
                                               placeholder="Enter API key"
                                               class="w-64 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all font-mono text-xs">
                                        <button type="button" @click="showApiKey = !showApiKey; $nextTick(() => lucide.createIcons())"
                                                class="p-2 rounded-lg hover:bg-neutral-100 transition-colors text-neutral-400 hover:text-neutral-600"
                                                title="Toggle visibility">
                                            <template x-if="!showApiKey">
                                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>
                                            </template>
                                            <template x-if="showApiKey">
                                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/><path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/><path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/><path d="m2 2 20 20"/></svg>
                                            </template>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Server Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="server" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Server</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Host</label>
                                        <span class="px-1.5 py-0.5 text-[9px] font-medium rounded bg-amber-50 text-amber-600 border border-amber-200">Restart</span>
                                    </div>
                                    <input type="text" x-model="globalSettings.server.host"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Port</label>
                                        <span class="px-1.5 py-0.5 text-[9px] font-medium rounded bg-amber-50 text-amber-600 border border-amber-200">Restart</span>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.server.port"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Log Level</label>
                                    </div>
                                    <select x-model="globalSettings.server.log_level"
                                            class="w-48 px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all bg-white">
                                        <option value="error">error</option>
                                        <option value="warning">warning</option>
                                        <option value="info">info (default)</option>
                                        <option value="debug">debug</option>
                                        <option value="trace">trace - includes full content</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Model Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="box" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Model</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Model Directory</label>
                                    </div>
                                    <input type="text" x-model="globalSettings.model.model_dir"
                                           class="w-64 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all font-mono text-xs">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Max Model Memory</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" min="0" max="100" step="5"
                                               x-model.number="memoryPercent"
                                               @input="updateMemoryFromSlider()"
                                               class="w-32 h-1.5 bg-neutral-200 rounded-full appearance-none cursor-pointer
                                                      [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3
                                                      [&::-webkit-slider-thumb]:bg-black [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                                                      [&::-webkit-slider-thumb]:shadow-sm">
                                        <span class="text-sm text-neutral-600 w-28 text-right">
                                            <span x-text="memoryPercent + '%'"></span>
                                            <span class="text-neutral-400">(<span x-text="getMemoryDisplay()"></span>)</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Batching Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="layers" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Batching</span>
                                </div>
                                <span class="px-2 py-0.5 text-[10px] font-medium rounded-full bg-amber-50 text-amber-600 border border-amber-200">
                                    Restart needed
                                </span>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Max Sequences</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Maximum concurrent requests processed in parallel</p>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.scheduler.max_num_seqs"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Prefill Batch Size</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Batch size for prompt encoding phase</p>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.scheduler.prefill_batch_size"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Completion Batch Size</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Batch size for token generation phase</p>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.scheduler.completion_batch_size"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>

                        <!-- Cache Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="hard-drive" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Cache</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Cache Enabled</label>
                                    </div>
                                    <button type="button" @click="globalSettings.cache.enabled = !globalSettings.cache.enabled"
                                            :class="globalSettings.cache.enabled ? 'bg-black' : 'bg-neutral-200'"
                                            class="relative w-11 h-6 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                        <span :class="globalSettings.cache.enabled ? 'translate-x-5' : 'translate-x-0'"
                                              class="block w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-300 absolute top-0.5 left-0.5"></span>
                                    </button>
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">SSD Cache Directory</label>
                                    </div>
                                    <input type="text" x-model="globalSettings.cache.ssd_cache_dir"
                                           class="w-64 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all font-mono text-xs">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <label class="text-sm text-neutral-700">Max Cache Size</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" min="0" max="100" step="5"
                                               x-model.number="cachePercent"
                                               @input="updateCacheFromSlider()"
                                               class="w-32 h-1.5 bg-neutral-200 rounded-full appearance-none cursor-pointer
                                                      [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3
                                                      [&::-webkit-slider-thumb]:bg-black [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer
                                                      [&::-webkit-slider-thumb]:shadow-sm">
                                        <span class="text-sm text-neutral-600 w-28 text-right inline-flex items-center justify-end gap-0">
                                            <span x-text="cachePercent + '%'"></span>
                                            <span class="text-neutral-400 ml-1">(</span><span x-show="!editingCache" @click="editingCache = true" class="cursor-pointer hover:text-neutral-900" x-text="cacheSizeGB"></span><input x-show="editingCache"
                                                   type="number"
                                                   :value="cacheSizeGB"
                                                   @change="updateCacheFromInput($event.target.value); editingCache = false"
                                                   @blur="editingCache = false"
                                                   @keydown.enter="updateCacheFromInput($event.target.value); editingCache = false"
                                                   @keydown.escape="editingCache = false"
                                                   x-init="if (editingCache) { $nextTick(() => $el.focus()) }"
                                                   class="w-12 px-1 text-sm text-right border border-neutral-900 rounded focus:outline-none"
                                                   min="0"
                                                   step="1"><span class="text-neutral-400">GB)</span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sampling Defaults Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="sliders" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Generation Defaults</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Max Context Window</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Reject prompts exceeding this token limit</p>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.sampling.max_context_window" min="1" max="2097152"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <label class="text-sm text-neutral-700">Max Tokens</label>
                                    <input type="number" x-model.number="globalSettings.sampling.max_tokens" min="1" max="131072"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Temperature</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">0.0 = deterministic, 2.0 = max randomness</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" min="0" max="2" step="0.1"
                                               x-model.number="globalSettings.sampling.temperature"
                                               class="w-24 h-1.5 bg-neutral-200 rounded-full appearance-none cursor-pointer
                                                      [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3
                                                      [&::-webkit-slider-thumb]:bg-black [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer">
                                        <input type="number" x-model.number="globalSettings.sampling.temperature" step="0.1" min="0" max="2"
                                               class="w-20 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Top P</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">Nucleus sampling threshold</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" min="0" max="1" step="0.05"
                                               x-model.number="globalSettings.sampling.top_p"
                                               class="w-24 h-1.5 bg-neutral-200 rounded-full appearance-none cursor-pointer
                                                      [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3
                                                      [&::-webkit-slider-thumb]:bg-black [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer">
                                        <input type="number" x-model.number="globalSettings.sampling.top_p" step="0.05" min="0" max="1"
                                               class="w-20 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                    </div>
                                </div>
                                <div class="flex items-center justify-between px-6 py-4">
                                    <div>
                                        <label class="text-sm text-neutral-700">Top K</label>
                                        <p class="text-xs text-neutral-400 mt-0.5">0 = disabled</p>
                                    </div>
                                    <input type="number" x-model.number="globalSettings.sampling.top_k" min="0"
                                           class="w-48 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>

                        <!-- MCP Section -->
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="plug" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">MCP</span>
                                </div>
                                <span class="px-2 py-0.5 text-[10px] font-medium rounded-full bg-amber-50 text-amber-600 border border-amber-200">
                                    Restart needed
                                </span>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <div class="flex items-center justify-between px-6 py-4">
                                    <label class="text-sm text-neutral-700">Config Path</label>
                                    <input type="text" x-model="globalSettings.mcp.config_path" placeholder="Path to MCP config"
                                           class="w-64 px-3 py-2 text-sm text-right border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all font-mono text-xs">
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Save Button -->
                    <div class="mt-10 flex items-center justify-between">
                        <div>
                            <!-- Success Message -->
                            <div x-show="saveSuccess" x-cloak
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:leave="transition ease-in duration-150"
                                 class="flex items-center gap-2 text-sm text-neutral-700">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span x-text="saveMessage"></span>
                            </div>
                            <!-- Error Message -->
                            <div x-show="saveError" x-cloak
                                 x-transition:enter="transition ease-out duration-200"
                                 x-transition:leave="transition ease-in duration-150"
                                 class="flex items-center gap-2 text-sm text-red-600">
                                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                                <span x-text="saveError"></span>
                            </div>
                        </div>
                        <button
                            @click="saveGlobalSettings"
                            :disabled="saving"
                            class="px-8 py-3 bg-neutral-900 text-white text-sm font-semibold
                                   rounded-full hover:bg-neutral-800 focus:outline-none focus:ring-2
                                   focus:ring-neutral-900 focus:ring-offset-2 transition-all duration-200
                                   transform hover:scale-105 active:scale-95
                                   disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        >
                            <span x-show="!saving">Save Settings</span>
                            <span x-show="saving" class="flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Saving...
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Model Settings Tab -->
            <div x-show="activeTab === 'models'" x-cloak>
                <div class="animate-fade-in-up">
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-2">Model Settings</h2>
                        <h3 class="text-2xl font-bold tracking-tight text-neutral-900">Available Models</h3>
                        <p class="text-sm text-neutral-500 mt-2">Configure per-model settings including sampling parameters.</p>
                    </div>

                    <!-- Loading State -->
                    <div x-show="loadingModels" class="p-12 text-center">
                        <svg class="animate-spin h-8 w-8 text-neutral-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-3 text-sm text-neutral-500">Loading models...</p>
                    </div>

                    <!-- Empty State -->
                    <div x-show="!loadingModels && models.length === 0" class="bg-white rounded-2xl border border-neutral-200 p-12 text-center">
                        <div class="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="package-x" class="w-8 h-8 text-neutral-400"></i>
                        </div>
                        <h4 class="text-lg font-semibold text-neutral-900 mb-2">No models found</h4>
                        <p class="text-sm text-neutral-500">Add models to your model directory to get started.</p>
                    </div>

                    <!-- Model Table -->
                    <div x-show="!loadingModels && models.length > 0" class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                        <!-- Table Header -->
                        <div class="flex items-center gap-4 px-6 py-3 bg-neutral-50 border-b border-neutral-200 text-xs font-bold uppercase tracking-wider text-neutral-500">
                            <div class="flex-1 min-w-0 flex items-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('id')">
                                Model
                                <span x-show="sortBy === 'id'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-20 text-center flex items-center justify-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('type')">
                                Type
                                <span x-show="sortBy === 'type'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-20 text-center flex items-center justify-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('size')">
                                Size
                                <span x-show="sortBy === 'size'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-20 text-center flex items-center justify-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('loaded')">
                                Status
                                <span x-show="sortBy === 'loaded'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-12 text-center flex items-center justify-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('pinned')">
                                Pin
                                <span x-show="sortBy === 'pinned'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-14 text-center flex items-center justify-center gap-1 cursor-pointer hover:text-neutral-700 select-none" @click="toggleSort('is_default')">
                                Default
                                <span x-show="sortBy === 'is_default'" x-text="sortOrder === 'asc' ? 'â–²' : 'â–¼'" class="text-[10px]"></span>
                            </div>
                            <div class="w-10 text-center"></div>
                        </div>

                        <!-- Table Body -->
                        <div class="divide-y divide-neutral-100">
                            <template x-for="model in sortedModels" :key="model.id">
                                <div class="hover:bg-neutral-50 transition-colors">
                                    <!-- Main Row -->
                                    <div class="flex items-center gap-4 px-6 py-4">
                                        <!-- Model Name -->
                                        <div class="flex-1 min-w-0 flex items-center gap-3">
                                            <div class="w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                                <i data-lucide="box" class="w-4 h-4 text-neutral-500"></i>
                                            </div>
                                            <p class="text-sm font-medium text-neutral-900 truncate" x-text="model.id"></p>
                                        </div>

                                        <!-- Type -->
                                        <div class="w-20 text-center flex-shrink-0">
                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-neutral-100 text-neutral-600"
                                                  x-text="model.model_type || 'llm'"></span>
                                        </div>

                                        <!-- Size -->
                                        <div class="w-20 text-center flex-shrink-0">
                                            <span class="text-sm text-neutral-600" x-text="model.estimated_size_formatted || '-'"></span>
                                        </div>

                                        <!-- Status -->
                                        <div class="w-20 text-center flex-shrink-0">
                                            <span :class="model.loaded
                                                      ? 'bg-neutral-900 text-white'
                                                      : 'bg-white text-neutral-500 border border-neutral-200'"
                                                  class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full gap-1">
                                                <span :class="model.loaded ? 'bg-white' : 'bg-neutral-400'"
                                                      class="w-1.5 h-1.5 rounded-full"></span>
                                                <span x-text="model.loaded ? 'Loaded' : 'Ready'"></span>
                                            </span>
                                        </div>

                                        <!-- Pin Toggle -->
                                        <div class="w-12 flex justify-center flex-shrink-0">
                                            <button
                                                @click="updateModelSetting(model.id, 'is_pinned', !model.pinned)"
                                                :class="model.pinned ? 'bg-black' : 'bg-neutral-200'"
                                                class="relative w-9 h-5 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black"
                                            >
                                                <span
                                                    :class="model.pinned ? 'translate-x-4' : 'translate-x-0'"
                                                    class="block w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform duration-300 absolute top-0.5 left-0.5"
                                                ></span>
                                            </button>
                                        </div>

                                        <!-- Default Radio (only for LLM models) -->
                                        <div class="w-14 flex justify-center flex-shrink-0">
                                            <template x-if="model.model_type === 'llm' || !model.model_type">
                                                <button
                                                    @click="updateModelSetting(model.id, 'is_default', true)"
                                                    :class="model.is_default
                                                        ? 'bg-black border-black'
                                                        : 'bg-white border-neutral-300 hover:border-neutral-400'"
                                                    class="w-4 h-4 rounded-full border-2 flex items-center justify-center transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black"
                                                >
                                                    <span x-show="model.is_default" class="w-1.5 h-1.5 bg-white rounded-full"></span>
                                                </button>
                                            </template>
                                            <template x-if="model.model_type && model.model_type !== 'llm'">
                                                <span class="text-xs text-neutral-300">â€”</span>
                                            </template>
                                        </div>

                                        <!-- Actions (icon only) - hidden for embedding/reranker models -->
                                        <div class="w-10 flex justify-center flex-shrink-0">
                                            <button
                                                x-show="!model.model_type || model.model_type === 'llm'"
                                                @click="openModelSettings(model)"
                                                class="p-2 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-all"
                                                title="Sampling Settings"
                                            >
                                                <i data-lucide="settings" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Sampling Settings Row (if any settings configured) - hidden for embedding/reranker models -->
                                    <div x-show="(!model.model_type || model.model_type === 'llm') && model.settings && (model.settings.max_context_window || model.settings.max_tokens || model.settings.temperature !== null || model.settings.top_p !== null || model.settings.top_k !== null || model.settings.force_sampling || model.settings.max_tool_result_tokens)"
                                         class="px-6 pb-4 -mt-2">
                                        <div class="ml-11 flex flex-wrap gap-2">
                                            <template x-if="model.settings?.max_context_window">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-amber-50 text-amber-700 border border-amber-200">
                                                    ctx_window: <span class="ml-1" x-text="model.settings.max_context_window"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.max_tokens">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-blue-50 text-blue-700 border border-blue-200">
                                                    max_tokens: <span class="ml-1" x-text="model.settings.max_tokens"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.temperature !== null && model.settings?.temperature !== undefined">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-orange-50 text-orange-700 border border-orange-200">
                                                    temp: <span class="ml-1" x-text="model.settings.temperature"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.top_p !== null && model.settings?.top_p !== undefined">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-green-50 text-green-700 border border-green-200">
                                                    top_p: <span class="ml-1" x-text="model.settings.top_p"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.top_k !== null && model.settings?.top_k !== undefined">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-purple-50 text-purple-700 border border-purple-200">
                                                    top_k: <span class="ml-1" x-text="model.settings.top_k"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.max_tool_result_tokens">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-teal-50 text-teal-700 border border-teal-200">
                                                    tool_result_tokens: <span class="ml-1" x-text="model.settings.max_tool_result_tokens"></span>
                                                </span>
                                            </template>
                                            <template x-if="model.settings?.force_sampling">
                                                <span class="inline-flex items-center px-2 py-0.5 text-[10px] font-medium rounded bg-red-50 text-red-700 border border-red-200">
                                                    force_sampling
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Models Main Tab -->
            <div x-show="mainTab === 'models'" x-cloak>
                <div class="animate-fade-in-up">
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-2">Models</h2>
                        <h3 class="text-2xl font-bold tracking-tight text-neutral-900">Model Manager</h3>
                        <p class="text-sm text-neutral-500 mt-2">Download models from HuggingFace and manage local models.</p>
                    </div>

                    <!-- Download Form Section -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-6">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="cloud-download" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Download from HuggingFace</span>
                            </div>
                        </div>
                        <div class="px-6 py-5">
                            <div class="flex items-end gap-4">
                                <div class="flex-1">
                                    <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-1.5">Repository ID</label>
                                    <input type="text" x-model="hfRepoId"
                                           @keydown.enter="startHFDownload()"
                                           placeholder="mlx-community/Llama-3-8B-4bit"
                                           class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm
                                                  focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all
                                                  bg-white font-mono text-xs"
                                    >
                                </div>
                                <div class="w-48">
                                    <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-1.5">
                                        HF Token <span class="text-neutral-400 normal-case">(optional)</span>
                                    </label>
                                    <input type="password" x-model="hfToken"
                                           @keydown.enter="startHFDownload()"
                                           placeholder="hf_..."
                                           class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm
                                                  focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all
                                                  bg-white font-mono text-xs"
                                    >
                                </div>
                                <button @click="startHFDownload()"
                                        :disabled="hfDownloading || !hfRepoId.trim()"
                                        class="px-6 py-2.5 bg-neutral-900 text-white text-sm font-semibold rounded-full
                                               hover:bg-neutral-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed
                                               flex items-center gap-2 whitespace-nowrap">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Download
                                </button>
                            </div>
                            <!-- Error message -->
                            <div x-show="hfError" x-cloak
                                 class="mt-3 px-4 py-2.5 bg-red-50 border border-red-200 text-red-700 text-sm rounded-xl flex items-center gap-2">
                                <i data-lucide="alert-circle" class="w-4 h-4 shrink-0"></i>
                                <span x-text="hfError"></span>
                            </div>
                            <!-- Success message -->
                            <div x-show="hfSuccess" x-cloak
                                 class="mt-3 px-4 py-2.5 bg-green-50 border border-green-200 text-green-700 text-sm rounded-xl flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 shrink-0"></i>
                                <span x-text="hfSuccess"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Models Section -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-6">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="star" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Recommended Models</span>
                                <span x-show="globalSettings.system.total_memory" x-cloak
                                      class="text-xs text-neutral-400" x-text="'for ' + globalSettings.system.total_memory + ' system'"></span>
                            </div>
                            <div class="flex items-center gap-1 bg-neutral-100 rounded-lg p-0.5">
                                <button @click="hfRecommendedTab = 'trending'"
                                        :class="hfRecommendedTab === 'trending'
                                            ? 'bg-white text-neutral-900 shadow-sm'
                                            : 'text-neutral-500 hover:text-neutral-700'"
                                        class="px-3 py-1 text-xs font-medium rounded-md transition-all">
                                    Trending
                                </button>
                                <button @click="hfRecommendedTab = 'popular'"
                                        :class="hfRecommendedTab === 'popular'
                                            ? 'bg-white text-neutral-900 shadow-sm'
                                            : 'text-neutral-500 hover:text-neutral-700'"
                                        class="px-3 py-1 text-xs font-medium rounded-md transition-all">
                                    Popular
                                </button>
                            </div>
                        </div>
                        <!-- Loading state -->
                        <div x-show="hfRecommendedLoading" x-cloak class="px-6 py-12 text-center">
                            <div class="inline-block w-5 h-5 border-2 border-neutral-300 border-t-neutral-600 rounded-full animate-spin mb-3"></div>
                            <p class="text-sm text-neutral-500">Loading recommendations...</p>
                        </div>
                        <!-- Empty state (not loaded yet, not loading) -->
                        <div x-show="!hfRecommendedLoading && !hfRecommendedLoaded" x-cloak class="px-6 py-12 text-center">
                            <i data-lucide="star" class="w-8 h-8 text-neutral-300 mx-auto mb-3"></i>
                            <p class="text-sm text-neutral-500">Click to load recommended models.</p>
                            <button @click="loadRecommendedModels()"
                                    class="mt-3 px-4 py-2 text-xs font-medium text-neutral-600 hover:text-neutral-800
                                           bg-neutral-100 hover:bg-neutral-200 rounded-lg transition-all">
                                Load Recommendations
                            </button>
                        </div>
                        <!-- Model list -->
                        <template x-if="hfRecommendedLoaded && !hfRecommendedLoading">
                            <div>
                                <!-- Trending tab -->
                                <div x-show="hfRecommendedTab === 'trending'" class="divide-y divide-neutral-100">
                                    <template x-if="hfRecommended.trending.length === 0">
                                        <div class="px-6 py-8 text-center">
                                            <p class="text-sm text-neutral-500">No trending models found for your system.</p>
                                        </div>
                                    </template>
                                    <template x-for="model in hfRecommended.trending" :key="model.repo_id">
                                        <div class="px-6 py-3.5 flex items-center justify-between hover:bg-neutral-50 transition-colors">
                                            <div class="min-w-0 flex-1">
                                                <a :href="'https://huggingface.co/' + model.repo_id" target="_blank" rel="noopener noreferrer"
                                                   class="text-sm font-medium text-neutral-900 hover:text-blue-600 truncate block transition-colors" x-text="model.name"></a>
                                                <div class="flex items-center gap-3 mt-0.5">
                                                    <span class="text-xs text-neutral-400" x-text="model.size_formatted"></span>
                                                    <span class="text-xs text-neutral-400" x-text="'&#11015; ' + formatDownloads(model.downloads)"></span>
                                                    <span class="text-xs text-neutral-400" x-text="'&#9829; ' + model.likes"></span>
                                                </div>
                                            </div>
                                            <button @click="downloadRecommended(model.repo_id)"
                                                    :disabled="hfDownloading"
                                                    class="px-3.5 py-1.5 text-xs font-medium text-neutral-600 bg-neutral-100
                                                           hover:bg-neutral-900 hover:text-white rounded-lg transition-all
                                                           disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5 shrink-0 ml-4">
                                                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                                                Download
                                            </button>
                                        </div>
                                    </template>
                                </div>
                                <!-- Popular tab -->
                                <div x-show="hfRecommendedTab === 'popular'" class="divide-y divide-neutral-100">
                                    <template x-if="hfRecommended.popular.length === 0">
                                        <div class="px-6 py-8 text-center">
                                            <p class="text-sm text-neutral-500">No popular models found for your system.</p>
                                        </div>
                                    </template>
                                    <template x-for="model in hfRecommended.popular" :key="model.repo_id">
                                        <div class="px-6 py-3.5 flex items-center justify-between hover:bg-neutral-50 transition-colors">
                                            <div class="min-w-0 flex-1">
                                                <a :href="'https://huggingface.co/' + model.repo_id" target="_blank" rel="noopener noreferrer"
                                                   class="text-sm font-medium text-neutral-900 hover:text-blue-600 truncate block transition-colors" x-text="model.name"></a>
                                                <div class="flex items-center gap-3 mt-0.5">
                                                    <span class="text-xs text-neutral-400" x-text="model.size_formatted"></span>
                                                    <span class="text-xs text-neutral-400" x-text="'&#11015; ' + formatDownloads(model.downloads)"></span>
                                                    <span class="text-xs text-neutral-400" x-text="'&#9829; ' + model.likes"></span>
                                                </div>
                                            </div>
                                            <button @click="downloadRecommended(model.repo_id)"
                                                    :disabled="hfDownloading"
                                                    class="px-3.5 py-1.5 text-xs font-medium text-neutral-600 bg-neutral-100
                                                           hover:bg-neutral-900 hover:text-white rounded-lg transition-all
                                                           disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1.5 shrink-0 ml-4">
                                                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                                                Download
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Download Queue Section -->
                    <template x-if="hfTasks.length > 0">
                        <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-6">
                            <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="list" class="w-4 h-4 text-neutral-500"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Download Queue</span>
                                </div>
                            </div>
                            <div class="divide-y divide-neutral-100">
                                <template x-for="task in hfTasks" :key="task.task_id">
                                    <div class="px-6 py-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 flex-wrap">
                                                    <span class="text-sm font-medium text-neutral-900 truncate" x-text="task.repo_id"></span>
                                                    <span class="px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wider rounded-full shrink-0"
                                                          :class="{
                                                              'bg-blue-50 text-blue-700 border border-blue-200': task.status === 'downloading',
                                                              'bg-green-50 text-green-700 border border-green-200': task.status === 'completed',
                                                              'bg-red-50 text-red-700 border border-red-200': task.status === 'failed',
                                                              'bg-neutral-100 text-neutral-600 border border-neutral-200': task.status === 'pending',
                                                              'bg-orange-50 text-orange-700 border border-orange-200': task.status === 'cancelled',
                                                          }"
                                                          x-text="task.status"></span>
                                                </div>
                                                <!-- Error message -->
                                                <p x-show="task.error" x-cloak class="text-xs text-red-500 mt-1.5 truncate" x-text="task.error"></p>
                                                <!-- Progress bar for downloading -->
                                                <template x-if="task.status === 'downloading'">
                                                    <div class="mt-2.5">
                                                        <div class="h-1.5 bg-neutral-100 rounded-full overflow-hidden">
                                                            <div class="h-full bg-neutral-900 rounded-full transition-all duration-500"
                                                                 :style="'width: ' + (task.total_size > 0 ? task.progress : 100) + '%'"
                                                                 :class="task.total_size <= 0 ? 'animate-pulse' : ''"></div>
                                                        </div>
                                                        <div class="flex items-center gap-3 mt-1.5 text-xs text-neutral-400">
                                                            <template x-if="task.total_size > 0">
                                                                <span x-text="formatProgress(task)"></span>
                                                            </template>
                                                            <template x-if="task.total_size <= 0">
                                                                <span>Downloading...</span>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                            <!-- Actions -->
                                            <div class="flex items-center gap-2 ml-4 shrink-0">
                                                <button x-show="task.status === 'downloading' || task.status === 'pending'" x-cloak
                                                        @click="cancelHFDownload(task.task_id)"
                                                        class="p-1.5 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                                                        title="Cancel download">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                                <button x-show="task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled'" x-cloak
                                                        @click="removeHFTask(task.task_id)"
                                                        class="p-1.5 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-lg transition-all"
                                                        title="Remove from list">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Local Models Section -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="hard-drive" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Local Models</span>
                                <span class="text-xs text-neutral-400" x-text="hfModels.length + ' models'"></span>
                            </div>
                            <button @click="loadHFModels()"
                                    class="px-3 py-1.5 text-xs font-medium text-neutral-500 hover:text-neutral-700
                                           hover:bg-neutral-100 rounded-lg transition-all flex items-center gap-1.5">
                                <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                                Refresh
                            </button>
                        </div>
                        <!-- Model list -->
                        <div class="divide-y divide-neutral-100">
                            <template x-if="hfModels.length === 0">
                                <div class="px-6 py-12 text-center">
                                    <i data-lucide="inbox" class="w-8 h-8 text-neutral-300 mx-auto mb-3"></i>
                                    <p class="text-sm text-neutral-500">No models found in model directory.</p>
                                </div>
                            </template>
                            <template x-for="model in hfModels" :key="model.name">
                                <div class="px-6 py-4 flex items-center justify-between hover:bg-neutral-50 transition-colors">
                                    <div class="min-w-0 flex-1">
                                        <span class="text-sm font-medium text-neutral-900 truncate block" x-text="model.name"></span>
                                        <span class="text-xs text-neutral-400" x-text="model.size_formatted"></span>
                                    </div>
                                    <div class="flex items-center gap-2 ml-4 shrink-0">
                                        <!-- Delete button -->
                                        <template x-if="hfDeleteConfirm !== model.name">
                                            <button @click="hfDeleteConfirm = model.name"
                                                    class="p-1.5 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                                                    title="Delete model">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </template>
                                        <!-- Delete confirmation -->
                                        <template x-if="hfDeleteConfirm === model.name">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-red-600">Delete?</span>
                                                <button @click="deleteHFModel(model.name)"
                                                        class="px-2.5 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-all">
                                                    Yes
                                                </button>
                                                <button @click="hfDeleteConfirm = null"
                                                        class="px-2.5 py-1 text-xs font-medium text-neutral-600 hover:bg-neutral-100 rounded-lg transition-all">
                                                    No
                                                </button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Main Tab -->
            <div x-show="mainTab === 'logs'" x-cloak>
                <div class="animate-fade-in-up">
                    <!-- Header -->
                    <div class="mb-8">
                        <h2 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-2">Logs</h2>
                        <h3 class="text-2xl font-bold tracking-tight text-neutral-900">Server Logs</h3>
                        <p class="text-sm text-neutral-500 mt-2">View real-time server logs with auto-refresh.</p>
                    </div>

                    <!-- Controls -->
                    <div class="bg-white rounded-2xl border border-neutral-200 overflow-hidden mb-4">
                        <div class="flex items-center justify-between px-6 py-4 bg-neutral-100 border-b border-neutral-200">
                            <div class="flex items-center gap-3">
                                <i data-lucide="terminal" class="w-4 h-4 text-neutral-500"></i>
                                <span class="text-xs font-bold uppercase tracking-wider text-neutral-600">Log Viewer</span>
                            </div>

                            <!-- Auto-refresh indicator -->
                            <div x-show="logAutoRefresh" class="flex items-center gap-2 text-sm text-green-600">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                Auto-refresh
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-4 px-6 py-4">
                            <!-- Lines input -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-neutral-600">Lines:</label>
                                <input type="number" x-model.number="logLines" min="10" max="10000" step="100"
                                       class="w-24 px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent">
                            </div>

                            <!-- Refresh interval input -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-neutral-600">Refresh:</label>
                                <input type="number" x-model.number="logRefreshInterval" min="0" max="300" step="1"
                                       @change="restartLogRefresh()"
                                       class="w-20 px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent">
                                <span class="text-sm text-neutral-400">sec (0=off)</span>
                            </div>

                            <!-- Log file selector -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-neutral-600">File:</label>
                                <select x-model="logFile" @change="loadLogs()"
                                        class="px-3 py-2 text-sm border border-neutral-200 rounded-lg focus:ring-2 focus:ring-neutral-900 focus:border-transparent bg-white">
                                    <template x-for="f in logAvailableFiles" :key="f">
                                        <option :value="f" x-text="f"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Manual refresh button -->
                            <button @click="loadLogs()"
                                    :disabled="logLoading"
                                    class="px-4 py-2 bg-neutral-900 text-white text-sm font-medium rounded-lg hover:bg-neutral-800 transition-all disabled:opacity-50">
                                <span x-show="!logLoading">Refresh</span>
                                <span x-show="logLoading">Loading...</span>
                            </button>

                            <!-- Auto-scroll toggle -->
                            <div class="flex items-center gap-2">
                                <button type="button" @click="logAutoScroll = !logAutoScroll"
                                        :class="logAutoScroll ? 'bg-black' : 'bg-neutral-200'"
                                        class="relative w-9 h-5 rounded-full transition-colors duration-300 focus:outline-none">
                                    <span :class="logAutoScroll ? 'translate-x-4' : 'translate-x-0'"
                                          class="block w-4 h-4 bg-white rounded-full shadow-sm transform transition-transform duration-300 absolute top-0.5 left-0.5"></span>
                                </button>
                                <label class="text-sm text-neutral-600">Auto-scroll</label>
                            </div>
                        </div>
                    </div>

                    <!-- Log Content -->
                    <div class="bg-neutral-900 rounded-2xl overflow-hidden">
                        <div class="flex items-center justify-between px-4 py-2 bg-neutral-800 border-b border-neutral-700">
                            <span class="text-xs text-neutral-400" x-text="'Showing ' + logLines + ' of ' + logTotalLines + ' lines'"></span>
                            <span class="text-xs text-neutral-500" x-text="logFile"></span>
                        </div>
                        <textarea
                            x-ref="logTextarea"
                            x-model="logContent"
                            readonly
                            class="w-full h-[600px] px-4 py-4 bg-neutral-900 text-green-400 font-mono text-xs leading-relaxed resize-none focus:outline-none"
                            placeholder="No logs available. Start the server to generate logs."
                        ></textarea>
                    </div>

                    <!-- Stats -->
                    <div class="mt-4 flex items-center justify-between text-sm text-neutral-500">
                        <span x-show="logLastUpdated" x-text="'Last updated: ' + logLastUpdated"></span>
                        <span x-show="logError" class="text-red-500" x-text="logError"></span>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Model Settings Modal -->
    <div x-show="showModelSettingsModal" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/50" @click="showModelSettingsModal = false"></div>

        <!-- Modal -->
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-3xl shadow-2xl w-full max-w-lg p-8"
                 @click.stop
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95">

                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xs font-bold uppercase tracking-widest text-neutral-400 mb-1">Model Settings</h3>
                        <h4 class="text-xl font-bold tracking-tight text-neutral-900" x-text="selectedModel?.name || selectedModel?.id"></h4>
                    </div>
                    <button @click="showModelSettingsModal = false"
                            class="p-2 text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 rounded-full transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Sampling Parameters -->
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Max Context Window</label>
                        <input type="number" x-model.number="modelSettings.max_context_window" placeholder="Default" min="1"
                               class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Max Tokens</label>
                            <input type="number" x-model.number="modelSettings.max_tokens" placeholder="Default"
                                   class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Temperature</label>
                            <input type="number" x-model.number="modelSettings.temperature" step="0.1" min="0" max="2" placeholder="Default"
                                   class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Top P</label>
                            <input type="number" x-model.number="modelSettings.top_p" step="0.05" min="0" max="1" placeholder="Default"
                                   class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase tracking-wider text-neutral-500 mb-2">Top K</label>
                            <input type="number" x-model.number="modelSettings.top_k" min="0" placeholder="Default"
                                   class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="p-4 bg-neutral-50 rounded-xl space-y-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm font-medium text-neutral-700">Limit Tool Result Tokens</span>
                                <p class="text-xs text-neutral-500 mt-0.5">Truncate large tool results (e.g. file reads) to a token limit</p>
                            </div>
                            <button type="button" @click="modelSettings.enableToolResultLimit = !modelSettings.enableToolResultLimit; if (!modelSettings.enableToolResultLimit) modelSettings.max_tool_result_tokens = null;"
                                    :class="modelSettings.enableToolResultLimit ? 'bg-black' : 'bg-neutral-200'"
                                    class="relative w-11 h-6 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                                <span :class="modelSettings.enableToolResultLimit ? 'translate-x-5' : 'translate-x-0'"
                                      class="block w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-300 absolute top-0.5 left-0.5"></span>
                            </button>
                        </div>
                        <div x-show="modelSettings.enableToolResultLimit" x-transition class="pt-1">
                            <input type="number" x-model.number="modelSettings.max_tool_result_tokens" placeholder="e.g. 2000" min="100" step="100"
                                   class="w-full px-4 py-2.5 border border-neutral-200 rounded-xl text-sm focus:ring-2 focus:ring-neutral-900 focus:border-transparent transition-all">
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-4 bg-neutral-50 rounded-xl">
                        <div>
                            <span class="text-sm font-medium text-neutral-700">Force Sampling</span>
                            <p class="text-xs text-neutral-500 mt-0.5">Override request sampling parameters with configured values</p>
                        </div>
                        <button type="button" @click="modelSettings.force_sampling = !modelSettings.force_sampling"
                                :class="modelSettings.force_sampling ? 'bg-black' : 'bg-neutral-200'"
                                class="relative w-11 h-6 rounded-full transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black">
                            <span :class="modelSettings.force_sampling ? 'translate-x-5' : 'translate-x-0'"
                                  class="block w-5 h-5 bg-white rounded-full shadow-sm transform transition-transform duration-300 absolute top-0.5 left-0.5"></span>
                        </button>
                    </div>

                    <p class="text-xs text-neutral-400 text-center">Leave empty to use global defaults</p>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end gap-3 mt-8">
                    <button @click="showModelSettingsModal = false"
                            class="px-5 py-2.5 text-sm font-medium text-neutral-600 hover:text-neutral-900 hover:bg-neutral-100 rounded-full transition-all">
                        Cancel
                    </button>
                    <button @click="saveModelSettings"
                            :disabled="savingModelSettings"
                            class="px-6 py-2.5 bg-neutral-900 text-white text-sm font-semibold rounded-full
                                   hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-900 focus:ring-offset-2
                                   transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!savingModelSettings">Save</span>
                        <span x-show="savingModelSettings">Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function dashboard() {
        return {
            // Theme
            theme: localStorage.getItem('omlx-chat-theme') || 'light',

            // Main tab state (Status, Settings, or Logs)
            mainTab: 'status',

            activeTab: 'global',
            settingsDropdown: false,

            // Global settings
            globalSettings: {
                base_path: '',
                server: { host: '127.0.0.1', port: 8000, log_level: 'info' },
                model: { model_dir: '', max_model_memory: '' },
                scheduler: { max_num_seqs: 8, prefill_batch_size: 8, completion_batch_size: 8 },
                cache: { enabled: true, ssd_cache_dir: '', ssd_cache_max_size: 'auto' },
                sampling: { max_context_window: 32768, max_tokens: 32768, temperature: 1.0, top_p: 0.95, top_k: 40 },
                mcp: { config_path: '' },
                auth: { api_key_set: false, api_key: '' },
                claude_code: { context_scaling_enabled: false, target_context_size: 200000 },
                system: { total_memory_bytes: 0, total_memory: '', auto_model_memory: '', ssd_total_bytes: 0, ssd_total: '', ssd_free_bytes: 0, ssd_free: '' },
            },

            // Memory slider (0-100%)
            memoryPercent: 80,
            // Cache slider (0-100%)
            cachePercent: 10,
            editingCache: false,

            // Models
            models: [],
            loadingModels: false,
            sortBy: 'id',
            sortOrder: 'asc',

            // Auth UI state
            showApiKey: false,

            // Saving state
            saving: false,
            saveSuccess: false,
            saveMessage: '',
            saveError: '',

            // Model settings modal
            showModelSettingsModal: false,
            selectedModel: null,
            modelSettings: {
                max_context_window: null,
                max_tokens: null,
                temperature: null,
                top_p: null,
                top_k: null,
                force_sampling: false,
                enableToolResultLimit: false,
                max_tool_result_tokens: null,
            },
            savingModelSettings: false,

            // Status tab state
            stats: {
                total_prompt_tokens: 0,
                total_cached_tokens: 0,
                cache_efficiency: 0.0,
                avg_prefill_tps: 0.0,
                avg_generation_tps: 0.0,
                total_requests: 0,
                port: 8000,
                api_key: '',
            },
            selectedClaudeModel: '',
            selectedStatsModel: '',
            _statsRefreshTimer: null,

            // Log viewer state
            logContent: '',
            logLines: 500,
            logRefreshInterval: 5,  // seconds, 0 = disabled
            logAutoRefresh: false,
            logAutoScroll: true,
            logLoading: false,
            logError: '',
            logFile: 'server.log',
            logAvailableFiles: ['server.log'],
            logTotalLines: 0,
            logLastUpdated: '',
            _logRefreshTimer: null,

            // HF Downloader state
            hfRepoId: '',
            hfToken: '',
            hfDownloading: false,
            hfTasks: [],
            hfModels: [],
            hfModelsLoaded: false,
            hfError: '',
            hfSuccess: '',
            _hfRefreshTimer: null,
            hfDeleteConfirm: null,

            // Recommended models state
            hfRecommended: { trending: [], popular: [] },
            hfRecommendedLoaded: false,
            hfRecommendedLoading: false,
            hfRecommendedTab: 'trending',

            async init() {
                // Apply theme
                this.applyTheme();

                await Promise.all([
                    this.loadGlobalSettings(),
                    this.loadModels()
                ]);
                this.$nextTick(() => {
                    lucide.createIcons();
                });

                // Load stats and start polling if starting on status tab
                if (this.mainTab === 'status') {
                    await this.loadStats();
                    this.startStatsRefresh();
                }

                // Watch for main tab changes to manage refresh timers
                this.$watch('mainTab', (value) => {
                    if (value === 'status') {
                        this.loadStats();
                        this.startStatsRefresh();
                    } else {
                        this.stopStatsRefresh();
                    }
                    if (value === 'logs') {
                        this.loadLogs();
                        this.startLogRefresh();
                    } else {
                        this.stopLogRefresh();
                    }
                    if (value === 'models') {
                        this.loadHFModels();
                        this.loadHFTasks();
                        if (!this.hfRecommendedLoaded) this.loadRecommendedModels();
                        const hasActive = this.hfTasks.some(t =>
                            t.status === 'pending' || t.status === 'downloading');
                        if (hasActive) this.startHFRefresh();
                    } else {
                        this.stopHFRefresh();
                    }
                    this.$nextTick(() => lucide.createIcons());
                });
            },

            async loadGlobalSettings() {
                try {
                    const response = await fetch('/admin/api/global-settings');
                    if (response.ok) {
                        const data = await response.json();
                        // Deep merge to preserve defaults for missing fields
                        this.globalSettings = {
                            ...this.globalSettings,
                            ...data,
                            server: { ...this.globalSettings.server, ...data.server },
                            model: { ...this.globalSettings.model, ...data.model },
                            scheduler: { ...this.globalSettings.scheduler, ...data.scheduler },
                            cache: { ...this.globalSettings.cache, ...data.cache },
                            sampling: { ...this.globalSettings.sampling, ...data.sampling },
                            mcp: { ...this.globalSettings.mcp, ...data.mcp },
                            auth: { ...this.globalSettings.auth, ...data.auth },
                            claude_code: { ...this.globalSettings.claude_code, ...data.claude_code },
                            system: { ...this.globalSettings.system, ...data.system },
                        };

                        // Calculate memory percent from stored value
                        this.memoryPercent = this.parseMemoryToPercent(
                            this.globalSettings.model.max_model_memory,
                            this.globalSettings.system.total_memory_bytes
                        );
                        // Sync the memory string value from percent
                        this.updateMemoryFromSlider();

                        // Calculate cache percent from stored value (based on free space)
                        this.cachePercent = this.parseCacheToPercent(
                            this.globalSettings.cache.ssd_cache_max_size,
                            this.globalSettings.system.ssd_free_bytes
                        );
                        // Sync the cache string value from percent
                        this.updateCacheFromSlider();
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load global settings:', err);
                }
            },

            async saveGlobalSettings() {
                this.saving = true;
                this.saveSuccess = false;
                this.saveError = '';

                // Validate required fields
                const errors = [];
                const s = this.globalSettings;
                if (!s.server.host) errors.push('Host');
                if (!s.server.port) errors.push('Port');
                if (!s.model.model_dir) errors.push('Model Directory');
                if (!s.scheduler.max_num_seqs) errors.push('Max Sequences');
                if (!s.scheduler.prefill_batch_size) errors.push('Prefill Batch Size');
                if (!s.scheduler.completion_batch_size) errors.push('Completion Batch Size');
                if (!s.cache.ssd_cache_max_size) errors.push('Max Cache Size');
                if (!s.sampling.max_context_window) errors.push('Max Context Window');
                if (!s.sampling.max_tokens) errors.push('Max Tokens');

                if (errors.length > 0) {
                    this.saveError = `Required fields cannot be empty: ${errors.join(', ')}`;
                    this.saving = false;
                    return;
                }

                // Validate API key if provided
                if (s.auth.api_key) {
                    if (s.auth.api_key.length < 4) {
                        this.saveError = 'API key must be at least 4 characters';
                        this.saving = false;
                        return;
                    }
                    if (/\s/.test(s.auth.api_key)) {
                        this.saveError = 'API key must not contain whitespace';
                        this.saving = false;
                        return;
                    }
                }

                try {
                    const response = await fetch('/admin/api/global-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            host: this.globalSettings.server.host,
                            port: this.globalSettings.server.port,
                            log_level: this.globalSettings.server.log_level,
                            model_dir: this.globalSettings.model.model_dir,
                            max_model_memory: this.globalSettings.model.max_model_memory,
                            max_num_seqs: this.globalSettings.scheduler.max_num_seqs,
                            prefill_batch_size: this.globalSettings.scheduler.prefill_batch_size,
                            completion_batch_size: this.globalSettings.scheduler.completion_batch_size,
                            cache_enabled: this.globalSettings.cache.enabled,
                            ssd_cache_dir: this.globalSettings.cache.ssd_cache_dir,
                            ssd_cache_max_size: this.globalSettings.cache.ssd_cache_max_size,
                            sampling_max_context_window: this.globalSettings.sampling.max_context_window,
                            sampling_max_tokens: this.globalSettings.sampling.max_tokens,
                            sampling_temperature: this.globalSettings.sampling.temperature,
                            sampling_top_p: this.globalSettings.sampling.top_p,
                            sampling_top_k: this.globalSettings.sampling.top_k,
                            mcp_config: this.globalSettings.mcp.config_path,
                            ...(this.globalSettings.auth.api_key ? { api_key: this.globalSettings.auth.api_key } : {}),
                        }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.saveSuccess = true;
                        this.saveMessage = data.message || 'Settings saved successfully';
                        this.$nextTick(() => lucide.createIcons());
                        // Refresh stats so Claude Code command reflects new API key
                        await this.loadStats();
                        setTimeout(() => { this.saveSuccess = false; }, 5000);
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    } else {
                        const data = await response.json();
                        this.saveError = Array.isArray(data.detail) ? data.detail.join(', ') : (data.detail || 'Failed to save settings');
                        // Reload settings to revert to server values
                        await this.loadGlobalSettings();
                        this.$nextTick(() => lucide.createIcons());
                    }
                } catch (err) {
                    console.error('Failed to save global settings:', err);
                    this.saveError = 'Failed to save settings';
                    // Reload settings to revert to server values
                    await this.loadGlobalSettings();
                    this.$nextTick(() => lucide.createIcons());
                } finally {
                    this.saving = false;
                }
            },

            async loadModels() {
                this.loadingModels = true;
                try {
                    const response = await fetch('/admin/api/models');
                    if (response.ok) {
                        const data = await response.json();
                        this.models = data.models || [];
                        this.$nextTick(() => lucide.createIcons());
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load models:', err);
                } finally {
                    this.loadingModels = false;
                }
            },

            async updateModelSetting(modelId, field, value) {
                try {
                    const response = await fetch(`/admin/api/models/${encodeURIComponent(modelId)}/settings`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ [field]: value }),
                    });

                    if (response.ok) {
                        if (field === 'is_default' && value === true) {
                            this.models.forEach(m => { m.is_default = (m.id === modelId); });
                        } else if (field === 'is_pinned') {
                            const model = this.models.find(m => m.id === modelId);
                            if (model) model.pinned = value;
                        }
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    } else {
                        const data = await response.json();
                        alert(data.detail || 'Failed to update model setting');
                        await this.loadModels();
                    }
                } catch (err) {
                    console.error('Failed to update model setting:', err);
                    alert('Failed to update model setting');
                    await this.loadModels();
                }
            },

            openModelSettings(model) {
                this.selectedModel = model;
                // Load existing settings if available
                const settings = model.settings || {};
                this.modelSettings = {
                    max_context_window: settings.max_context_window || null,
                    max_tokens: settings.max_tokens || null,
                    temperature: settings.temperature ?? null,
                    top_p: settings.top_p ?? null,
                    top_k: settings.top_k ?? null,
                    force_sampling: settings.force_sampling || false,
                    enableToolResultLimit: !!(settings.max_tool_result_tokens),
                    max_tool_result_tokens: settings.max_tool_result_tokens || null,
                };
                this.showModelSettingsModal = true;
                this.$nextTick(() => lucide.createIcons());
            },

            async saveModelSettings() {
                if (!this.selectedModel) return;

                this.savingModelSettings = true;
                try {
                    const response = await fetch(`/admin/api/models/${encodeURIComponent(this.selectedModel.id)}/settings`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            max_context_window: this.modelSettings.max_context_window || null,
                            max_tokens: this.modelSettings.max_tokens || null,
                            temperature: this.modelSettings.temperature ?? null,
                            top_p: this.modelSettings.top_p ?? null,
                            top_k: this.modelSettings.top_k ?? null,
                            force_sampling: this.modelSettings.force_sampling,
                            max_tool_result_tokens: this.modelSettings.enableToolResultLimit
                                ? (this.modelSettings.max_tool_result_tokens || null)
                                : 0,
                        }),
                    });

                    if (response.ok) {
                        // Update local model data from server response
                        const data = await response.json();
                        const model = this.models.find(m => m.id === this.selectedModel.id);
                        if (model) {
                            model.settings = data.settings || {};
                        }
                        this.showModelSettingsModal = false;
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    } else {
                        const data = await response.json();
                        alert(data.detail || 'Failed to save model settings');
                    }
                } catch (err) {
                    console.error('Failed to save model settings:', err);
                    alert('Failed to save model settings');
                } finally {
                    this.savingModelSettings = false;
                }
            },

            // Status tab functions
            get llmModels() {
                return this.models.filter(m => m.model_type === 'llm' || !m.model_type);
            },

            get claudeCodeCommand() {
                const model = this.selectedClaudeModel || 'select-a-model';
                const port = this.stats.port || 8000;
                const parts = [];
                parts.push(`ANTHROPIC_BASE_URL=http://localhost:${port}`);
                if (this.stats.api_key) {
                    parts.push(`ANTHROPIC_AUTH_TOKEN=${this.stats.api_key}`);
                }
                parts.push(`ANTHROPIC_MODEL=${model}`);
                parts.push(`ANTHROPIC_DEFAULT_SONNET_MODEL=${model}`);
                parts.push(`ANTHROPIC_DEFAULT_OPUS_MODEL=${model}`);
                parts.push(`ANTHROPIC_DEFAULT_HAIKU_MODEL=${model}`);
                parts.push('API_TIMEOUT_MS=3000000');
                parts.push('CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1');
                parts.push('claude');
                return parts.join(' ');
            },

            async saveClaudeCodeSettings() {
                try {
                    const response = await fetch('/admin/api/global-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            claude_code_context_scaling_enabled: this.globalSettings.claude_code.context_scaling_enabled,
                            claude_code_target_context_size: this.globalSettings.claude_code.target_context_size,
                        }),
                    });
                    if (!response.ok) {
                        console.error('Failed to save Claude Code settings');
                    }
                } catch (err) {
                    console.error('Failed to save Claude Code settings:', err);
                }
            },

            async loadStats() {
                try {
                    const params = new URLSearchParams();
                    if (this.selectedStatsModel) {
                        params.set('model', this.selectedStatsModel);
                    }
                    const url = '/admin/api/stats' + (params.toString() ? '?' + params : '');
                    const response = await fetch(url);
                    if (response.ok) {
                        const data = await response.json();
                        this.stats = { ...this.stats, ...data };
                        // Set default selected model if not set
                        if (!this.selectedClaudeModel && this.llmModels.length > 0) {
                            this.selectedClaudeModel = this.llmModels[0].id;
                        }
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load stats:', err);
                }
            },

            async clearStats() {
                try {
                    await fetch('/admin/api/stats/clear', { method: 'POST' });
                    await this.loadStats();
                } catch (err) {
                    console.error('Failed to clear stats:', err);
                }
            },

            startStatsRefresh() {
                this.stopStatsRefresh();
                this._statsRefreshTimer = setInterval(() => {
                    this.loadStats();
                }, 1000);
            },

            stopStatsRefresh() {
                if (this._statsRefreshTimer) {
                    clearInterval(this._statsRefreshTimer);
                    this._statsRefreshTimer = null;
                }
            },

            formatNumber(num) {
                if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
                if (num >= 10000000) return (num / 1000000).toFixed(1) + 'M';
                return num.toLocaleString();
            },

            getStatFontClass(value) {
                if (value >= 1000000000) return 'text-2xl';
                if (value >= 1000000) return 'text-3xl';
                return 'text-5xl';
            },

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Could add visual feedback here
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            },

            async logout() {
                try {
                    await fetch('/admin/api/logout', { method: 'POST' });
                } catch (err) {
                    console.error('Logout error:', err);
                } finally {
                    window.location.href = '/admin';
                }
            },

            // Log viewer functions
            async loadLogs() {
                this.logLoading = true;
                this.logError = '';

                try {
                    const params = new URLSearchParams({
                        lines: this.logLines.toString(),
                    });
                    if (this.logFile && this.logFile !== 'server.log') {
                        params.append('file', this.logFile);
                    }

                    const response = await fetch(`/admin/api/logs?${params}`);

                    if (response.ok) {
                        const data = await response.json();
                        this.logContent = data.logs;
                        this.logTotalLines = data.total_lines;
                        this.logAvailableFiles = data.available_files || ['server.log'];
                        this.logLastUpdated = new Date().toLocaleTimeString();

                        // Auto-scroll to bottom
                        if (this.logAutoScroll) {
                            this.$nextTick(() => {
                                const textarea = this.$refs.logTextarea;
                                if (textarea) {
                                    textarea.scrollTop = textarea.scrollHeight;
                                }
                            });
                        }
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    } else {
                        const data = await response.json();
                        this.logError = data.detail || 'Failed to load logs';
                    }
                } catch (err) {
                    console.error('Failed to load logs:', err);
                    this.logError = 'Failed to load logs';
                } finally {
                    this.logLoading = false;
                }
            },

            startLogRefresh() {
                this.stopLogRefresh();  // Clear existing timer

                if (this.logRefreshInterval > 0) {
                    this.logAutoRefresh = true;
                    this._logRefreshTimer = setInterval(() => {
                        this.loadLogs();
                    }, this.logRefreshInterval * 1000);
                }
            },

            stopLogRefresh() {
                if (this._logRefreshTimer) {
                    clearInterval(this._logRefreshTimer);
                    this._logRefreshTimer = null;
                }
                this.logAutoRefresh = false;
            },

            restartLogRefresh() {
                if (this.mainTab === 'logs') {
                    this.startLogRefresh();
                }
            },

            // Parse stored memory value (e.g., "102GB") to percent of usable memory
            parseMemoryToPercent(memoryStr, totalBytes) {
                const usableBytes = Math.max(0, totalBytes - 8 * 1024 * 1024 * 1024);
                if (!memoryStr || !usableBytes || usableBytes === 0) {
                    return 80; // Default 80%
                }

                // Parse memory string like "102GB", "50GB", etc.
                const match = memoryStr.match(/^(\d+(?:\.\d+)?)\s*(GB|MB|TB)?$/i);
                if (!match) {
                    return 80; // Default if not parseable
                }

                let bytes = parseFloat(match[1]);
                const unit = (match[2] || 'GB').toUpperCase();

                if (unit === 'TB') bytes *= 1024 * 1024 * 1024 * 1024;
                else if (unit === 'GB') bytes *= 1024 * 1024 * 1024;
                else if (unit === 'MB') bytes *= 1024 * 1024;

                const percent = Math.round((bytes / usableBytes) * 100);
                return Math.min(100, Math.max(0, percent));
            },

            // Get max usable memory (total - 8GB reserved for system)
            get maxUsableMemoryBytes() {
                const totalBytes = this.globalSettings.system?.total_memory_bytes || 0;
                const reservedBytes = 8 * 1024 * 1024 * 1024; // 8GB
                return Math.max(0, totalBytes - reservedBytes);
            },

            // Convert percent to memory string (e.g., 80 -> "102GB")
            // Percent is based on usable memory (total - 8GB)
            percentToMemoryString(percent, totalBytes) {
                const usableBytes = Math.max(0, totalBytes - 8 * 1024 * 1024 * 1024);
                if (!usableBytes || usableBytes === 0) return 'auto';
                const bytes = Math.floor((percent / 100) * usableBytes);
                const gb = Math.floor(bytes / (1024 * 1024 * 1024));
                return `${gb}GB`;
            },

            // Get formatted memory for display
            getMemoryDisplay() {
                const totalBytes = this.globalSettings.system?.total_memory_bytes || 0;
                if (!totalBytes) return '-';
                const usableBytes = Math.max(0, totalBytes - 8 * 1024 * 1024 * 1024);
                const bytes = Math.floor((this.memoryPercent / 100) * usableBytes);
                const gb = Math.round(bytes / (1024 * 1024 * 1024));
                return `${gb}GB`;
            },

            // Update memory value when slider changes
            updateMemoryFromSlider() {
                const totalBytes = this.globalSettings.system?.total_memory_bytes || 0;
                this.globalSettings.model.max_model_memory = this.percentToMemoryString(this.memoryPercent, totalBytes);
            },

            // Parse cache size string (e.g., "10GB") to percent of SSD free space
            parseCacheToPercent(cacheStr, freeBytes) {
                if (!cacheStr || cacheStr === 'auto' || !freeBytes || freeBytes === 0) {
                    return 10; // Default 10%
                }

                const match = cacheStr.match(/^(\d+(?:\.\d+)?)\s*(GB|MB|TB)?$/i);
                if (!match) return 10;

                let bytes = parseFloat(match[1]);
                const unit = (match[2] || 'GB').toUpperCase();

                if (unit === 'TB') bytes *= 1024 * 1024 * 1024 * 1024;
                else if (unit === 'GB') bytes *= 1024 * 1024 * 1024;
                else if (unit === 'MB') bytes *= 1024 * 1024;

                const percent = Math.round((bytes / freeBytes) * 100);
                return percent; // Allow >100% for manual input
            },

            // Convert percent to cache size string
            percentToCacheString(percent, freeBytes) {
                if (!freeBytes || freeBytes === 0) return 'auto';
                const bytes = Math.floor((percent / 100) * freeBytes);
                const gb = Math.floor(bytes / (1024 * 1024 * 1024));
                return `${gb}GB`;
            },

            // Computed cache size in GB (for manual input)
            get cacheSizeGB() {
                const freeBytes = this.globalSettings.system?.ssd_free_bytes || 0;
                if (!freeBytes) return 0;
                const bytes = Math.floor((this.cachePercent / 100) * freeBytes);
                return Math.round(bytes / (1024 * 1024 * 1024));
            },

            // Update cache from slider
            updateCacheFromSlider() {
                const freeBytes = this.globalSettings.system?.ssd_free_bytes || 0;
                this.globalSettings.cache.ssd_cache_max_size = this.percentToCacheString(this.cachePercent, freeBytes);
            },

            // Update cache from manual GB input
            updateCacheFromInput(gbValue) {
                const gb = parseInt(gbValue) || 0;
                this.globalSettings.cache.ssd_cache_max_size = `${gb}GB`;

                // Update percent slider (allow >100%)
                const freeBytes = this.globalSettings.system?.ssd_free_bytes || 0;
                if (freeBytes > 0) {
                    const bytes = gb * 1024 * 1024 * 1024;
                    this.cachePercent = Math.round((bytes / freeBytes) * 100);
                }
            },

            // Sort models
            get sortedModels() {
                return [...this.models].sort((a, b) => {
                    let aVal, bVal;

                    switch (this.sortBy) {
                        case 'id':
                            aVal = (a.id || '').toLowerCase();
                            bVal = (b.id || '').toLowerCase();
                            break;
                        case 'type':
                            aVal = (a.model_type || 'llm').toLowerCase();
                            bVal = (b.model_type || 'llm').toLowerCase();
                            break;
                        case 'size':
                            aVal = a.estimated_size || 0;
                            bVal = b.estimated_size || 0;
                            break;
                        case 'loaded':
                            aVal = a.loaded ? 1 : 0;
                            bVal = b.loaded ? 1 : 0;
                            break;
                        case 'pinned':
                            aVal = a.pinned ? 1 : 0;
                            bVal = b.pinned ? 1 : 0;
                            break;
                        case 'is_default':
                            aVal = a.is_default ? 1 : 0;
                            bVal = b.is_default ? 1 : 0;
                            break;
                        default:
                            return 0;
                    }

                    if (aVal < bVal) return this.sortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return this.sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            },

            toggleSort(column) {
                if (this.sortBy === column) {
                    this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortBy = column;
                    this.sortOrder = 'asc';
                }
            },

            // Theme toggle
            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('omlx-chat-theme', this.theme);
                this.applyTheme();
                this.$nextTick(() => lucide.createIcons());
            },

            applyTheme() {
                document.documentElement.setAttribute('data-theme', this.theme);
            },

            // =================================================================
            // HuggingFace Downloader Functions
            // =================================================================

            async startHFDownload() {
                const repoId = this.hfRepoId.trim();
                if (!repoId) return;

                this.hfError = '';
                this.hfSuccess = '';
                this.hfDownloading = true;

                try {
                    const response = await fetch('/admin/api/hf/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            repo_id: repoId,
                            hf_token: this.hfToken,
                        }),
                    });

                    if (response.ok) {
                        this.hfSuccess = `Download started: ${repoId}`;
                        this.hfRepoId = '';
                        await this.loadHFTasks();
                        this.startHFRefresh();
                        setTimeout(() => { this.hfSuccess = ''; }, 5000);
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    } else {
                        const data = await response.json();
                        this.hfError = data.detail || 'Failed to start download';
                    }
                } catch (err) {
                    console.error('Failed to start download:', err);
                    this.hfError = 'Failed to start download. Check server connection.';
                } finally {
                    this.hfDownloading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            async loadHFTasks() {
                try {
                    const response = await fetch('/admin/api/hf/tasks');
                    if (response.ok) {
                        const data = await response.json();
                        this.hfTasks = data.tasks || [];

                        // Stop refresh if no active downloads
                        const hasActive = this.hfTasks.some(t =>
                            t.status === 'pending' || t.status === 'downloading');
                        if (!hasActive) {
                            this.stopHFRefresh();
                            // Refresh model lists when all downloads finish
                            if (this.hfTasks.some(t => t.status === 'completed')) {
                                await this.loadHFModels();
                                await this.loadModels();
                            }
                        }

                        this.$nextTick(() => lucide.createIcons());
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load HF tasks:', err);
                }
            },

            async loadHFModels() {
                try {
                    const response = await fetch('/admin/api/hf/models');
                    if (response.ok) {
                        const data = await response.json();
                        this.hfModels = data.models || [];
                        this.hfModelsLoaded = true;
                        this.$nextTick(() => lucide.createIcons());
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load HF models:', err);
                }
            },

            async cancelHFDownload(taskId) {
                try {
                    const response = await fetch(`/admin/api/hf/cancel/${taskId}`, {
                        method: 'POST',
                    });
                    if (response.ok) {
                        await this.loadHFTasks();
                    }
                } catch (err) {
                    console.error('Failed to cancel download:', err);
                }
            },

            async removeHFTask(taskId) {
                try {
                    const response = await fetch(`/admin/api/hf/task/${taskId}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        await this.loadHFTasks();
                    }
                } catch (err) {
                    console.error('Failed to remove task:', err);
                }
            },

            async deleteHFModel(modelName) {
                this.hfDeleteConfirm = null;
                try {
                    const response = await fetch(`/admin/api/hf/models/${encodeURIComponent(modelName)}`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        await this.loadHFModels();
                        await this.loadModels();
                    } else {
                        const data = await response.json();
                        this.hfError = data.detail || 'Failed to delete model';
                        setTimeout(() => { this.hfError = ''; }, 5000);
                    }
                } catch (err) {
                    console.error('Failed to delete model:', err);
                    this.hfError = 'Failed to delete model. Check server connection.';
                    setTimeout(() => { this.hfError = ''; }, 5000);
                }
            },

            startHFRefresh() {
                this.stopHFRefresh();
                this._hfRefreshTimer = setInterval(() => {
                    this.loadHFTasks();
                }, 2000);
            },

            stopHFRefresh() {
                if (this._hfRefreshTimer) {
                    clearInterval(this._hfRefreshTimer);
                    this._hfRefreshTimer = null;
                }
            },

            formatProgress(task) {
                const pct = Math.round(task.progress || 0);
                const dlGB = (task.downloaded_size / (1024 ** 3)).toFixed(1);
                const totalGB = (task.total_size / (1024 ** 3)).toFixed(1);
                return `${pct}% \u00b7 ${dlGB} GB / ${totalGB} GB`;
            },

            // =================================================================
            // Recommended Models Functions
            // =================================================================

            async loadRecommendedModels() {
                this.hfRecommendedLoading = true;
                try {
                    const response = await fetch('/admin/api/hf/recommended');
                    if (response.ok) {
                        this.hfRecommended = await response.json();
                        this.hfRecommendedLoaded = true;
                    } else if (response.status === 401) {
                        window.location.href = '/admin';
                    }
                } catch (err) {
                    console.error('Failed to load recommended models:', err);
                } finally {
                    this.hfRecommendedLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            downloadRecommended(repoId) {
                this.hfRepoId = repoId;
                this.startHFDownload();
            },

            formatDownloads(count) {
                if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
                if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
                return count.toString();
            },
        }
    }
</script>
{% endblock %}
