# oMLX venvstacks configuration
# Build portable macOS app with MLX bundled

[[runtimes]]
name = "cpython-3.11"
python_implementation = "cpython@3.11.10"
requirements = []
platforms = [
    "macosx_arm64",
]

[[frameworks]]
name = "mlx-framework"
runtime = "cpython-3.11"
requirements = [
    # Core MLX
    "mlx>=0.29.2",
    # mlx-lm from latest commit (834fac9) - aligned with pyproject.toml
    "mlx-lm @ git+https://github.com/ml-explore/mlx-lm@834fac934c4e04de9b3d723e2b9287a2c60cfd4a",
    # mlx-embeddings from latest commit (88522e2) - aligned with pyproject.toml
    "mlx-embeddings @ git+https://github.com/Blaizzy/mlx-embeddings@88522e288c0142170a5a44fd93c184d8ed777371",
    # Server dependencies
    "fastapi>=0.100.0",
    "uvicorn>=0.23.0",
    # Tokenizers and transformers (aligned with pyproject.toml)
    "transformers>=5.0.0",
    "tokenizers>=0.19.0",
    "huggingface-hub>=0.23.0",
    # Other dependencies
    "numpy>=1.24.0",
    "tqdm>=4.66.0",
    "pyyaml>=6.0",
    "itsdangerous>=2.0",
    "jinja2>=3.0",
    "sentencepiece",
    "protobuf",
    "requests>=2.28.0",
    "psutil>=5.9.0",
    "jsonschema>=4.0.0",
    "tabulate>=0.9.0",
    # MCP support
    "mcp>=1.0.0",
    # Harmony format parser for gpt-oss models
    "openai-harmony",
]
platforms = [
    "macosx_arm64",
]
# Exclude cv2's duplicate dylibs (same libs already provided by Pillow/PIL)
dynlib_exclude = [
    "cv2/.dylibs/libavif*",
    "cv2/.dylibs/liblcms2*",
    "cv2/.dylibs/libpng16*",
    "cv2/.dylibs/libtiff*",
    "cv2/.dylibs/libfreetype*",
    "cv2/.dylibs/libharfbuzz*",
    "cv2/.dylibs/liblzma*",
    "cv2/.dylibs/libxcb*",
    "cv2/.dylibs/libXau*",
]

[[applications]]
name = "omlx-app"
launch_module = "omlx_app"
frameworks = ["mlx-framework"]
requirements = [
    # PyObjC for native macOS menubar app
    "pyobjc-core>=10.0",
    "pyobjc-framework-Cocoa>=10.0",
]
platforms = [
    "macosx_arm64",
]

[tool.uv]
exclude-newer = "2026-02-08T00:00:00Z"
environments = [
    "sys_platform == 'darwin' and platform_machine == 'arm64'",
]
